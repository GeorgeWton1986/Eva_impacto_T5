---
title: "EVALUACIÓN DE IMPACTO - TALLER 5"
author: "VIÁFARA MORALES, JORGE ELIECER"
date: "2025-09-27"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

## Introducción

En su artículo “Islamic Rule and the Empowerment of the Poor and Pious”, Meyersson (2014) investiga si la llegada al poder por parte del Partido Islámico tiene algún efecto sobre el empoderamiento de las mujeres en Turquía. Para esto, implementa la metodología de Regresión Discontinua, explotando información de: (1) elecciones locales de alcalde en Turquía del año 1994 y (2) mujeres con educación secundaria completa en el año 2000. Concretamente, estima por MCO la siguiente ecuación

\begin{align}
y_{i}=α+\beta m_i+f(x_i)+ε_i\quad \nonumber \\
\end{align}

Donde: 
$y_i$ es la proporción de mujeres entre 15 y 20 años con educación secundaria completa en el año 2000.

$x_i$ es el margen de votos con el que ganó o perdió el candidato del partido islámico.

$f(⋅)$ es un polinomio de grado $n$ de la variable $x_i$.
$m_i$ es una dicótoma que toma el valor de uno si $x_i≥0$, es decir, si el alcalde que llegó al poder en 1994 era del partido Islámico.

$ε_i$ es el término del error. La ecuación es estimada en un vecindario alrededor del corte, el cual, en este caso, es cero.

En este taller, ustedes realizarán algunas de las estimaciones hechas por el autor e interpretarán los resultados. Para esto, deben usar una submuestra aleatoria de la base de datos turquia.dta. Así, justo después de abrir la base de datos – i.e., la base completa, deben eliminar aleatoriamente el 5% de las observaciones y usar la base restante.  La semilla que deben usar para que sus resultados sean replicables es su código de estudiante. 

Como su solución a este conjunto de problemas, proporcione un documento PDF con sus respuestas y el do file (u otro programa) que usó para resolverlo. Se recomienda tener respuestas tan breves como sea posible. Ciertas preguntas, sobre todo aquellas que preguntan por su opinión, pueden no tener una única respuesta correcta. Así, lo importante es que argumenten de manera coherente. No seguir estas instrucciones básicas resultará en penalizaciones en su calificación.

## Primer Punto
1.	¿Por qué el autor usa la metodología de Regresión Discontinua para identificar los efectos de interés? ¿Cuál es la intuición detrás? ¿Cuál es el supuesto de identificación?

### Solución Primer Punto

a)	¿Por qué el autor usa la metodología de Regresión Discontinua para identificar los efectos de interés? 

**Respuesta:** El autor usa la metodología de Regresión Discontinua (RD) porque quiere identificar el impacto causal local de las leyes o políticas islamicas en terminos de resultados de la educación a nivel municipal, haciando una distinción entre ganar o perder las elecciones por parte del partido islamico.

Es decir, es conocido que un gobierno islamico representa pobreza, religiosidad, tradiciones conservadoras y derechos restringidos para las mujeres. 

b)	¿Cuál es la intuición detrás?

**Respuesta:** El diseño de un RD permite establecer un punto de corte (Umbral) $c=0$ de acuerdo con el indice de elegibilidad $m_i$. 

c)	¿Cuál es el supuesto de identificación?

**Respuesta:** Las caracteristica observables y no observables varian levemente alrededor del umbral. Además, no hay manipulación de la variable de asignación $x_i$ alrededor del umbral.

## Segundo Punto
2.	Para cada género, presenten en una tabla los resultados de estimar las siguientes especificaciones

### Generalidades de R
```{r}
#Limpiar la consola
cat("\f")

#Limpiar el Global Environment
rm(list = ls())

#Incluir las librerias
if(!require(pacman)) install.packages("pacman") ; require(pacman)
p_load(haven,   #Leer archivos .dta
      dplyr,    #Manipular datos
      stargazer,  #Visualizar tablas de regresión
      fixest,   #Calcular los efectos fijos
      plm,  #Datos de panel
      knitr,   #Visualizar tablas adicionales
      ivreg,  #Regresiones por variables instrumentales
      broom, #Extraer resultados de regresiones
      AER,    #Regresiones por variables instrumentales
      sandwich, #Errores estándar robustos
      lmtest,  #Pruebas estadísticas
      kableExtra, #Tablas avanzadas
      tidyverse, #Conjunto de paquetes para ciencia de datos
      modelsummary, #Resumir modelos
      ggplot2 #Gráficos
      )
```

### Transformación de datos en R
```{r}
# Definir URL del repositorio
github_url <- "https://raw.githubusercontent.com/GeorgeWton1986/Eva_impacto_T5/main"
# Cargar datos
BD_0 <- read_dta(paste0(github_url, "/Data/turquia.dta"))


# Ver estructura de los datos
#glimpse(BD_0)
#head(BD_0)

# Verificar los nombres de la columnas
colnames(BD_0)
```


```{r}
# Incluir la semilla con mi código de estudiante
set.seed(202415176)

# Eliminar aleatoriamente el 5% de las observaciones
BD_1 <- BD_0 %>% sample_frac(0.95)

# Incluir la variable dicotoma, si gano el partido Islamico en 1994

BD_1 <- BD_1 %>%
  mutate(
    islamic_mayor_1994 = ifelse(ilmvsm1994 >= 0, 1, 0)
  )

# Verificar dimensiones
cat("Observaciones después de eliminar 5%:", nrow(BD_1), "\n")

# Valor de la banda optimo

h_hat <- 0.24

# Submuestra 1

BD_h <- BD_1 %>%
  filter(abs(ilmvsm1994) <= h_hat)

# Submuestra 2

BD_h2 <- BD_1 %>%
  filter(abs(ilmvsm1994) <= h_hat/2)

cat("Observaciones completa:", nrow(BD_1), "\n")
cat("Observaciones en submuestra h=0,24:", nrow(BD_h), "\n")
cat("Observaciones en submuestra h/2=0,12:", nrow(BD_h2), "\n")

#Controles

controles <- c("vshr_islam1994", "partycount", "lpop1994",
               "ageshr19", "ageshr60", "sexr", "shhs",
               "merkezi", "merkezp", "buyuk", "subbuyuk")

#Incluir los controles a la base principal

controles_disponibles <- controles[controles %in% colnames(BD_1)]
cat("Controles disponibles:", paste(controles_disponibles, collapse=", "), "\n")

```

**Respuesta:** A continuación, presentamos el desarrollo de los modelos.

Manual avanzado de R markdown: https://rpubs.com/ricardo/14631 

### Solución Segundo Punto

a) Ecuación principal, para toda la muestra, sin incluir controles.
```{r warning=FALSE, message=FALSE}
# Modelo a

# Caso mujeres

modelo_2m_a <- feols(
  hischshr1520f ~ islamic_mayor_1994,
  data = BD_1,
  cluster = ~prov
)

# Caso hombre

modelo_2h_a <- feols(
  hischshr1520m ~ islamic_mayor_1994,
  data = BD_1,
  cluster = ~prov
)
```

b) Ecuación principal, para toda la muestra, con controles.
```{r warning=FALSE, message=FALSE}
# Modelo b

# formula compacta con controles mujeres

formula_m_b <- as.formula(paste(
  "hischshr1520f ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994 +",
  paste(controles_disponibles, collapse = " + ")
))

# Especificación completa con controles mujeres

modelo_2m_b <- feols(
  formula_m_b,
  data = BD_1,
  cluster = ~prov
)

# formula compacta con controles hombre

formula_h_b <- as.formula(paste(
  "hischshr1520m ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994 +",
  paste(controles_disponibles, collapse = " + ")
))

# Especificación completa con controles hombres

modelo_2h_b <- feols(
  formula_h_b,
  data = BD_1,
  cluster = ~prov
)

```

c) Ecuación principal, para la submuestra a  $\hat{h}$ unidades alrededor del corte, con controles.
```{r warning=FALSE, message=FALSE}
# Modelo c

# Especificación con submuestra $\hat{h}$ = 0,24 mujeres

modelo_2m_c <- feols(
  formula_m_b,
  data = BD_h,
  cluster = ~prov
)

# Especificación con submuestra $\hat{h}$ = 0,24 hombres

modelo_2h_c <- feols(
  formula_h_b,
  data = BD_h,
  cluster = ~prov
)

```


d) Ecuación principal, para la submuestra a  $\hat{h}/2$ unidades alrededor del corte, con controles.

donde $\hat{h}=0,24$ es el ancho de banda óptimo estimado por los autores. Para las especificaciones con controles, supongan que: 

\begin{align}
f(x_i)=\gamma x_i+\delta x_i×m_i \quad \nonumber \\
\end{align}

Es decir, un polinomio de grado uno con pendiente distinta a cada lado del corte.  Para las especificaciones sin controles, no incluyan ningún polinomio. Todas las especificaciones deben usar errores estándar clúster a nivel de provincia. 

```{r warning=FALSE, message=FALSE}
# Modelo d

# Especificación con submuestra $\hat{h}/2$ = 0,12 mujeres

modelo_2m_d <- feols(
  formula_m_b,
  data = BD_h2,
  cluster = ~prov
)

# Especificación con submuestra $\hat{h}/2$ = 0,12 hombres

modelo_2h_d <- feols(
  formula_h_b,
  data = BD_h2,
  cluster = ~prov
)

```

A continuación, se presenta la tabla de resultados.

```{r warning=FALSE, message=FALSE}
# Tabla de resultados para mujeres entre 15 y 20 años educadas hasta secundaria.

modelos_mujeres <- list(
  "(a) Sin controles" = modelo_2m_a,
  "(b) Con controles" = modelo_2m_b,
  "(c) h=0.24" = modelo_2m_c,
  "(d) h=0.12" = modelo_2m_d
)

#Table 1 Efecto en la educación de la mujeres

modelsummary(
  modelos_mujeres,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  coef_rename = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
  gof_map = c("nobs", "r.squared"),
  title = "Proporción mujeres 15-20 con secundaria completa"
)

# Tabla de resultados para hombres entre 15 y 20 años educadas hasta secundaria.

modelos_hombres <- list(
  "(a) Sin controles" = modelo_2h_a,
  "(b) Con controles" = modelo_2h_b,
  "(c) h=0.24" = modelo_2h_c,
  "(d) h=0.12" = modelo_2h_d
)

```

Resultado del efecto en la eduacion de las mujeres:
```{r warning=FALSE, message=FALSE}

#Table 1 Efecto en la educación de la mujeres

cat("\n=== TABLA 1: EFECTOS EN EDUCACIÓN - MUJERES ===\n")
modelsummary(
  modelos_mujeres,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  coef_rename = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
  gof_map = c("nobs", "r.squared"),
  title = "Proporción mujeres 15-20 con secundaria completa"
)

# Extraer coeficientes

coefs_mujeres <- sapply(modelos_mujeres, function(m) {
  coef_val <- coef(m)["islamic_mayor_1994"]
  se_val <- sqrt(vcov(m)["islamic_mayor_1994", "islamic_mayor_1994"])
  c(coef = coef_val, se = se_val)
})

cat("\n=== RESUMEN COEFICIENTES MUJERES ===\n")
print(t(coefs_mujeres))

```

Resultado del efecto en la eduacion de los hombres:
```{r warning=FALSE, message=FALSE}

#Table 1 Efecto en la educación de la hombres

cat("\n=== TABLA 2: EFECTOS EN EDUCACIÓN - HOMBRES ===\n")
modelsummary(
  modelos_hombres,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  coef_rename = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
  gof_map = c("nobs", "r.squared"),
  title = "Proporción hombres 15-20 con secundaria completa"
)

# Extraer coeficientes hombres

coefs_hombres <- sapply(modelos_hombres, function(m) {
  coef_val <- coef(m)["islamic_mayor_1994"]
  se_val <- sqrt(vcov(m)["islamic_mayor_1994", "islamic_mayor_1994"])
  c(coef = coef_val, se = se_val)
})

cat("\n=== RESUMEN COEFICIENTES HOMBRES ===\n")
print(t(coefs_hombres))

```



## Tercer Punto
3.	A partir de los resultados encontrados en el anterior punto, respondan:

### Solución tercer Punto
a) ¿Por qué cambian los coeficientes entre especificaciones?

**Respuesta:** Los cambios en los coeficinetes obedecen a la inclusión o no de controles, al tamaño de la muestra (amplitud de la banda) y cada uno de los modelos tienen diferentes problemas de identificación. Veamos:

**Modelo a Sin controles:** El coeficiente estimado (-0.027)*** presenta una correlación entre la variable eduación secundarias en niñas entre los 15 y 20 años y la varible dicotoma que respesenta la victoria del partido islamico en las elecciones de 1994. Por lo tanto, el coeficiente puede estar sesgado, por omisión de variables y no puede ser interpretados como un efecto causal.

**Modelo b Con controles:** El coeficiente estimado (0.012)* se ajusta al incluir las varibales de control, a tal punto que el signo del coeficiente cambio respecto del modelo a. Además, el ajuste de la especificación permitio que los sesgos de selección se redujeran por lo controles. No obsetante, los municipios son dispares entre sí.

**Modelo c h=0.24:** El coeficiente estimado (0.025)*** tiene una especificación con controles y una amplitud de banda de 0.24, inidicado que se realiza una comparación entre los municipios más cercanos al umbral ($c=0$), asegurando asi que la selección es casi aleatoria. Por lo tanto, se puede establecer que se minimiza el sesgo y este coeficiente puede ser interpretado como un efecto causal local (LATE).

**Modelo d h=0.12:** El coeficiente estimado (0.029)** fue calculado con una especificación con controles y una amplitud de banda de 0.12, estas caracteristas disminuyen en número de observaciones y generan homogeniedad en la muestra de municipios que se estan comparando al rededor del umbral ($c=0$). Sin embargo, la disminución en el número de observaciones puede aumentar la varianza del estimador. Ahora, en terminos generales, el coeficiente tiene un valor cercano al modelo c, que puede sugerir una validación por robustez.

b) ¿Cuál parece ser el impacto de la llegada al poder del Partido Islámico para las mujeres? 

**Respuesta:** De conformidad con la tabla 1 columna 3 (0.025)***, el efecto de la llegada al poder del Partido Islámico para las mujeres entre 15 y 20 años con secundaria completa, es positivo y significativo al 1%. Entonces, su interpretación sería la siguiente: La llegada de un alcalde islámico en 1994, incremento en promedio 2.5 puntos percetuales la proporción de mujeres entre 15 y 20 años con educación secundaria completa en el año 2000, en los municipios cercanos al umbral de victoria electoral. En terminos relativos, se puede establecer que fue de 2.5/16.3=15.34% (Proporción promedio de mujeres con secundaria completa en 2000).

¿Parece ser este impacto robusto a las especificaciones?

**Respuesta:** Si, el impacto es robusto cuando se comparan las columnas 3 y 4 de la tabla 1, entendiendo que los coeficientes son positivos y sus significancias estadisticas varian entre el 1% y el 5%. Puede existir otra manera de comparación frente a la columna 1, donde la especificación genera una correlación y el estimados es negativo. En conclusión, el cambio del signo entre los modelos confirma el efecto causal robusto.  

## Cuarto Punto

4. Finalmente, presenten evidencia a favor (o en contra) del supuesto de identificación. Para esto,

### Solución cuarto Punto
a) Presenten en una gráfica la distribución kernel o el histograma  de la variable de asignación $x_i$. ¿Parece haber manipulación?

```{r warning=FALSE, message=FALSE}

# Figura 1 Histograma con 99 bins
p1 <- ggplot(BD_1, aes(x = ilmvsm1994)) +
  geom_histogram(bins = 99, fill = "steelblue", color = "black", alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1.2) +
  labs(
    title = "Figura 1: Test de Manipulación - Distribución del Margen de Victoria",
    subtitle = "McCrary (2008) Density Test",
    x = "Margen de victoria del partido islámico (ilmvsm1994)",
    y = "Frecuencia",
    caption = "Nota: Si hay salto en x=0 → evidencia de manipulación"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )

print(p1)
ggsave("figura1_manipulacion.png", width = 10, height = 6)

# Figura 2 Densidad kernel
p2 <- ggplot(BD_1, aes(x = ilmvsm1994)) +
  geom_density(fill = "steelblue", alpha = 0.5, color = "darkblue", size = 1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1.2) +
  labs(
    title = "Figura 2: Densidad Kernel del Margen de Victoria",
    x = "Margen de victoria del partido islámico",
    y = "Densidad",
    caption = "Nota: Si hay salto en x=0 → evidencia de manipulación"
  ) +
  theme_minimal() + 
    theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )

print(p2)
ggsave("figura2_densidad.png", width = 10, height = 6)

```

**Respuesta:** A partir de los resultados observados en el figura 1 (Histograma) y la figura 2 (Densidad de Kernel), no se observa un salto en la distribución la variable $x_i$ (ilmvsm1994) - es el margen de votos con el que ganó o perdió el candidato del partido islámico-. Información que concuerda con el Autor Meyersson (2014), quien no encuentra evidencia de manipulación en la variable de asignación alrededor del umbral ($c=0$).

b) En una tabla presenten los resultados de estimar la ecuación de interés, sin controles, pero incluyendo $f(x_i)$, tomando como variables dependientes: i) la elección de un alcalde del partido Islámico en 1984 $(i89)$ y ii) el logaritmo de la población en 1994 $(lpop1994)$. Para esto, usen únicamente la muestra de elecciones alrededor del ancho de banda óptimo. Dados sus resultados, ¿parece haber continuidad en estas variables?

```{r warning=FALSE, message=FALSE}

# Test 1: Islamic mayor 1989
test_i89 <- feols(
  i89 ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994,
  data = BD_h,
  cluster = ~prov
)

# Test 2: Log población 1994
test_lpop <- feols(
  lpop1994 ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994,
  data = BD_h,
  cluster = ~prov
)

# Tabla de tests
cat("\n=== TABLA 3: TESTS DE BALANCE ===\n")
tests_balance <- list(
  "Islamic Mayor 1989" = test_i89,
  "Log Población 1994" = test_lpop
)

modelsummary(
  tests_balance,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  coef_rename = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
  gof_map = c("nobs", "r.squared"),
  title = "Tests de Continuidad en Covariables Pre-Tratamiento"
)

# Extraer p-values
pval_i89 <- summary(test_i89)$coeftable["islamic_mayor_1994", "Pr(>|t|)"]
pval_lpop <- summary(test_lpop)$coeftable["islamic_mayor_1994", "Pr(>|t|)"]

cat("\n=== RESULTADOS TESTS ===\n")
cat("Islamic Mayor 1989:\n")
cat("  Coeficiente:", round(coef(test_i89)["islamic_mayor_1994"], 4), "\n")
cat("  P-value:", round(pval_i89, 4), "\n")
cat("\nLog Población 1994:\n")
cat("  Coeficiente:", round(coef(test_lpop)["islamic_mayor_1994"], 4), "\n")
cat("  P-value:", round(pval_lpop, 4), "\n")


```

**Respuesta:** A partir de los resultados presentados en la tabla 3 (Tests de Balance), se realiza un prueba de hipótesis para cada una de las variables dependientes:


Ho: No hay discontinuidad con alcalde islámico 5 años atras. El p-valor es mayor a 0.10, por lo tanto, no se rechaza Ho. Los municipios que estan cerca al umbral son similares en terminos de la variable i89.

Ho: No hay discontinuidad en tamaño poblacional. El p-valor es mayor a 0.10, por lo tanto, no se rechaza Ho. Los municipios pequeños o grandes tienen igual probabilidad de estar cerca del umbral.

En conclusión, no hay evidencia de discontinuidad en las variables analizadas en el tabla 3, toda vez las pruebas de hipotesis resultaron en no rechazo de la Ho.

c) Dados sus resultados en los incisos a y b, ¿es plausible el supuesto de identificación? Expliquen por qué.

**Respuesta:** El supuesto de identificación para una RD, se basa en la manipulación y el test de balance. Luego de corroborar estas mediciones que se resolvieron en los puntos a y b, se puede concluir que el supuesto de identificación es plausible, ya que:

1. No existe evidencia de manipulación, la distribución es continua en el umbral ($c=0$). Esto sugiere que los candidatos no pudieron controlar los resultados electorales.

2. Balanceo, la caracteristicas previas al tratamiento (elección de alcalde islámico en 1989 y tamaño poblacional en 1994) no presentan discontinuidad en el umbral ($c=0$). Esto indica que los municipios cercanos al umbral son comparables.
