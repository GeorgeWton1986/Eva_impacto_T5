rddensity #Test de McCrary
)
# Definir URL del repositorio
github_url <- "https://raw.githubusercontent.com/GeorgeWton1986/Eva_impacto_T5/main"
# Cargar datos
BD_0 <- read_dta(paste0(github_url, "/Data/turquia.dta"))
# Ver estructura de los datos
#glimpse(BD_0)
#head(BD_0)
# Verificar los nombres de la columnas
colnames(BD_0)
# Incluir la semilla con mi código de estudiante
set.seed(202415176)
# Eliminar aleatoriamente el 5% de las observaciones
BD_1 <- BD_0 %>% sample_frac(0.95)
# Incluir la variable dicotoma, si gano el partido Islamico en 1994
BD_1 <- BD_1 %>%
mutate(
islamic_mayor_1994 = ifelse(ilmvsm1994 >= 0, 1, 0)
)
# Verificar dimensiones
cat("Observaciones después de eliminar 5%:", nrow(BD_1), "\n")
# Valor de la banda optimo
h_hat <- 0.24
# Submuestra 1
BD_h <- BD_1 %>%
filter(abs(ilmvsm1994) <= h_hat)
# Submuestra 2
BD_h2 <- BD_1 %>%
filter(abs(ilmvsm1994) <= h_hat/2)
cat("Observaciones completa:", nrow(BD_1), "\n")
cat("Observaciones en submuestra h=0,24:", nrow(BD_h), "\n")
cat("Observaciones en submuestra h/2=0,12:", nrow(BD_h2), "\n")
#Controles
controles <- c("vshr_islam1994", "partycount", "lpop1994",
"ageshr19", "ageshr60", "sexr", "shhs",
"merkezi", "merkezp", "buyuk", "subbuyuk")
#Incluir los controles a la base principal
controles_disponibles <- controles[controles %in% colnames(BD_1)]
cat("Controles disponibles:", paste(controles_disponibles, collapse=", "), "\n")
# Modelo a
# Caso mujeres
modelo_2m_a <- feols(
hischshr1520f ~ islamic_mayor_1994,
data = BD_1,
cluster = ~prov
)
# Caso hombre
modelo_2h_a <- feols(
hischshr1520m ~ islamic_mayor_1994,
data = BD_1,
cluster = ~prov
)
# Modelo b
# formula compacta con controles mujeres
formula_m_b <- as.formula(paste(
"hischshr1520f ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994 +",
paste(controles_disponibles, collapse = " + ")
))
# Especificación completa con controles mujeres
modelo_2m_b <- feols(
formula_m_b,
data = BD_1,
cluster = ~prov
)
# formula compacta con controles hombre
formula_h_b <- as.formula(paste(
"hischshr1520m ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994 +",
paste(controles_disponibles, collapse = " + ")
))
# Especificación completa con controles hombres
modelo_2h_b <- feols(
formula_h_b,
data = BD_1,
cluster = ~prov
)
# Modelo c
# Especificación con submuestra $\hat{h}$ = 0,24 mujeres
modelo_2m_c <- feols(
formula_m_b,
data = BD_h,
cluster = ~prov
)
# Especificación con submuestra $\hat{h}$ = 0,24 hombres
modelo_2h_c <- feols(
formula_h_b,
data = BD_h,
cluster = ~prov
)
# Modelo d
# Especificación con submuestra $\hat{h}/2$ = 0,12 mujeres
modelo_2m_d <- feols(
formula_m_b,
data = BD_h2,
cluster = ~prov
)
# Especificación con submuestra $\hat{h}/2$ = 0,12 hombres
modelo_2h_d <- feols(
formula_h_b,
data = BD_h2,
cluster = ~prov
)
# Tabla de resultados para mujeres entre 15 y 20 años educadas hasta secundaria.
#Tabla 1 Efecto en la educación de las mujeres
etable(
modelo_2m_a, modelo_2m_b, modelo_2m_c, modelo_2m_d,
tex = TRUE,
title = "Efecto de Gobierno Islámico en Educación Femenina",
headers = c("(a)", "(b)", "(c)", "(d)"),
dict = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
keep = "Islamic",
extralines = list(
"Controles" = c("No", "Sí", "Sí", "Sí"),
"Muestra" = c("Completa", "Completa", "h=0.24", "h=0.12"),
"Polinomio flexible" = c("No", "Sí", "Sí", "Sí")
),
notes = "Nota: Errores estándar clustered por provincia entre paréntesis.",
fontsize = "small",
digits = 4,
digits.stats = 1
)
#Tabla 2 Efecto en la educación de la hombres
etable(
modelo_2h_a, modelo_2h_b, modelo_2h_c, modelo_2h_d,
tex = TRUE,
title = "Efecto de Gobierno Islámico en Educación Masculina",
headers = c("(a)", "(b)", "(c)", "(d)"),
dict = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
keep = "Islamic",
extralines = list(
"Controles" = c("No", "Sí", "Sí", "Sí"),
"Muestra" = c("Completa", "Completa", "h=0.24", "h=0.12")
),
notes = "Nota: Errores estándar clustered por provincia entre paréntesis.",
fontsize = "small",
digits = 4,
digits.stats = 1
)
# Figura 1 Histograma con 99 bins
p1 <- ggplot(BD_1, aes(x = ilmvsm1994)) +
geom_histogram(bins = 99, fill = "steelblue", color = "black", alpha = 0.7) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1.2) +
labs(
title = "Figura 1: Test de Manipulación - Distribución del Margen de Victoria",
subtitle = "McCrary (2008) Density Test",
x = "Margen de victoria del partido islámico (ilmvsm1994)",
y = "Frecuencia",
caption = "Nota: Si hay salto en x=0 → evidencia de manipulación"
) +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
plot.subtitle = element_text(hjust = 0.5)
)
print(p1)
ggsave("figura1_manipulacion.png", width = 10, height = 6)
# Figura 2 Densidad kernel
p2 <- ggplot(BD_1, aes(x = ilmvsm1994)) +
geom_density(fill = "steelblue", alpha = 0.5, color = "darkblue", size = 1) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1.2) +
labs(
title = "Figura 2: Densidad Kernel del Margen de Victoria",
x = "Margen de victoria del partido islámico",
y = "Densidad",
caption = "Nota: Si hay salto en x=0 → evidencia de manipulación"
) +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
plot.subtitle = element_text(hjust = 0.5)
)
print(p2)
ggsave("figura2_densidad_Kernel.png", width = 10, height = 6)
# Test formal
density_test <- rddensity(
X = BD_1$ilmvsm1994,
c = 0,
p = 2,              # Polinomio local orden 2
q = 3,              # Bias correction orden 3
kernel = "triangular",
fitselect = "unrestricted"
)
# Mostrar resumen
summary(density_test)
# Extraer resultados clave
test_stat <- density_test$test$t_jk
pvalue <- density_test$test$p_jk
bandwidth_izq <- density_test$h$left
bandwidth_der <- density_test$h$right
# Crear el objeto con histograma para obtener los datos
rdplot_obj <- rdplotdensity(
rdd = density_test,
X = BD_1$ilmvsm1994,
plotRange = c(-0.5, 0.5),
plotN = 25,
plotGrid = c("es","qs"),
type = "points",
CIshade = 0.2,
hist = FALSE,
histBreaks = NULL,
histFillCol = "gray90",
histLineCol = "white",
title = "Figura 3: Test de McCrary",
xlabel = "Islamic win margin (ilmvsm1994)",
ylabel = "Density"
)
dev.copy(png, "figura3_Test_mccrary.png", width = 2400, height = 1800, res = 300)
dev.off()
# Test 1: Islamic mayor 1989
test_i89 <- feols(
i89 ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994,
data = BD_h,
cluster = ~prov
)
# Test 2: Log población 1994
test_lpop <- feols(
lpop1994 ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994,
data = BD_h,
cluster = ~prov
)
# Extraer p-values
pval_i89 <- summary(test_i89)$coeftable["islamic_mayor_1994", "Pr(>|t|)"]
pval_lpop <- summary(test_lpop)$coeftable["islamic_mayor_1994", "Pr(>|t|)"]
# Tabla 3 Tests de Balance
etable(
test_i89, test_lpop,
tex = TRUE,
title = "Tests de Balance con P-valores",
headers = c("Islamic 1989", "Log Población 1994"),
dict = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
keep = "Islamic",
extralines = list(
"P-value" = c(sprintf("%.4f", pval_i89), sprintf("%.4f", pval_lpop)),
"Balanceado?" = c(
ifelse(pval_i89 > 0.10, "Sí", "No"),
ifelse(pval_lpop > 0.10, "Sí", "No")
)
),
digits = 4
)
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
fig.align = "center",
fig.pos = "H",
results = 'asis'
)
# Configurar opciones
options(modelsummary_factory_default = "gt")
options(kableExtra.latex.load_packages = FALSE)
#Limpiar la consola
cat("\f")
#Limpiar el Global Environment
rm(list = ls())
#Incluir las librerias
if(!require(pacman)) install.packages("pacman") ; require(pacman)
p_load(haven,   #Leer archivos .dta
dplyr,    #Manipular datos
stargazer,  #Visualizar tablas de regresión
fixest,   #Calcular los efectos fijos
plm,  #Datos de panel
knitr,   #Visualizar tablas adicionales
ivreg,  #Regresiones por variables instrumentales
broom, #Extraer resultados de regresiones
AER,    #Regresiones por variables instrumentales
sandwich, #Errores estándar robustos
lmtest,  #Pruebas estadísticas
kableExtra, #Tablas avanzadas
tidyverse, #Conjunto de paquetes para ciencia de datos
modelsummary, #Resumir modelos
ggplot2, #Gráficos
rddensity #Test de McCrary
)
# Definir URL del repositorio
github_url <- "https://raw.githubusercontent.com/GeorgeWton1986/Eva_impacto_T5/main"
# Cargar datos
BD_0 <- read_dta(paste0(github_url, "/Data/turquia.dta"))
# Ver estructura de los datos
#glimpse(BD_0)
#head(BD_0)
# Verificar los nombres de la columnas
colnames(BD_0)
# Incluir la semilla con mi código de estudiante
set.seed(202415176)
# Eliminar aleatoriamente el 5% de las observaciones
BD_1 <- BD_0 %>% sample_frac(0.95)
# Incluir la variable dicotoma, si gano el partido Islamico en 1994
BD_1 <- BD_1 %>%
mutate(
islamic_mayor_1994 = ifelse(ilmvsm1994 >= 0, 1, 0)
)
# Verificar dimensiones
cat("Observaciones después de eliminar 5%:", nrow(BD_1), "\n")
# Valor de la banda optimo
h_hat <- 0.24
# Submuestra 1
BD_h <- BD_1 %>%
filter(abs(ilmvsm1994) <= h_hat)
# Submuestra 2
BD_h2 <- BD_1 %>%
filter(abs(ilmvsm1994) <= h_hat/2)
cat("Observaciones completa:", nrow(BD_1), "\n")
cat("Observaciones en submuestra h=0,24:", nrow(BD_h), "\n")
cat("Observaciones en submuestra h/2=0,12:", nrow(BD_h2), "\n")
#Controles
controles <- c("vshr_islam1994", "partycount", "lpop1994",
"ageshr19", "ageshr60", "sexr", "shhs",
"merkezi", "merkezp", "buyuk", "subbuyuk")
#Incluir los controles a la base principal
controles_disponibles <- controles[controles %in% colnames(BD_1)]
cat("Controles disponibles:", paste(controles_disponibles, collapse=", "), "\n")
# Modelo a
# Caso mujeres
modelo_2m_a <- feols(
hischshr1520f ~ islamic_mayor_1994,
data = BD_1,
cluster = ~prov
)
# Caso hombre
modelo_2h_a <- feols(
hischshr1520m ~ islamic_mayor_1994,
data = BD_1,
cluster = ~prov
)
# Modelo b
# formula compacta con controles mujeres
formula_m_b <- as.formula(paste(
"hischshr1520f ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994 +",
paste(controles_disponibles, collapse = " + ")
))
# Especificación completa con controles mujeres
modelo_2m_b <- feols(
formula_m_b,
data = BD_1,
cluster = ~prov
)
# formula compacta con controles hombre
formula_h_b <- as.formula(paste(
"hischshr1520m ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994 +",
paste(controles_disponibles, collapse = " + ")
))
# Especificación completa con controles hombres
modelo_2h_b <- feols(
formula_h_b,
data = BD_1,
cluster = ~prov
)
# Modelo c
# Especificación con submuestra $\hat{h}$ = 0,24 mujeres
modelo_2m_c <- feols(
formula_m_b,
data = BD_h,
cluster = ~prov
)
# Especificación con submuestra $\hat{h}$ = 0,24 hombres
modelo_2h_c <- feols(
formula_h_b,
data = BD_h,
cluster = ~prov
)
# Modelo d
# Especificación con submuestra $\hat{h}/2$ = 0,12 mujeres
modelo_2m_d <- feols(
formula_m_b,
data = BD_h2,
cluster = ~prov
)
# Especificación con submuestra $\hat{h}/2$ = 0,12 hombres
modelo_2h_d <- feols(
formula_h_b,
data = BD_h2,
cluster = ~prov
)
# Tabla de resultados para mujeres entre 15 y 20 años educadas hasta secundaria.
#Tabla 1 Efecto en la educación de las mujeres
etable(
modelo_2m_a, modelo_2m_b, modelo_2m_c, modelo_2m_d,
tex = TRUE,
title = "Efecto de Gobierno Islámico en Educación Femenina",
headers = c("(a)", "(b)", "(c)", "(d)"),
dict = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
keep = "Islamic",
extralines = list(
"Controles" = c("No", "Sí", "Sí", "Sí"),
"Muestra" = c("Completa", "Completa", "h=0.24", "h=0.12"),
"Polinomio flexible" = c("No", "Sí", "Sí", "Sí")
),
notes = "Nota: Errores estándar clustered por provincia entre paréntesis.",
fontsize = "small",
digits = 4,
digits.stats = 1
)
#Tabla 2 Efecto en la educación de la hombres
etable(
modelo_2h_a, modelo_2h_b, modelo_2h_c, modelo_2h_d,
tex = TRUE,
title = "Efecto de Gobierno Islámico en Educación Masculina",
headers = c("(a)", "(b)", "(c)", "(d)"),
dict = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
keep = "Islamic",
extralines = list(
"Controles" = c("No", "Sí", "Sí", "Sí"),
"Muestra" = c("Completa", "Completa", "h=0.24", "h=0.12")
),
notes = "Nota: Errores estándar clustered por provincia entre paréntesis.",
fontsize = "small",
digits = 4,
digits.stats = 1
)
# Figura 1 Histograma con 99 bins
p1 <- ggplot(BD_1, aes(x = ilmvsm1994)) +
geom_histogram(bins = 99, fill = "steelblue", color = "black", alpha = 0.7) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1.2) +
labs(
title = "Figura 1: Test de Manipulación - Distribución del Margen de Victoria",
subtitle = "McCrary (2008) Density Test",
x = "Margen de victoria del partido islámico (ilmvsm1994)",
y = "Frecuencia",
caption = "Nota: Si hay salto en x=0 → evidencia de manipulación"
) +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
plot.subtitle = element_text(hjust = 0.5)
)
print(p1)
ggsave("figura1_manipulacion.png", width = 10, height = 6)
# Figura 2 Densidad kernel
p2 <- ggplot(BD_1, aes(x = ilmvsm1994)) +
geom_density(fill = "steelblue", alpha = 0.5, color = "darkblue", size = 1) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1.2) +
labs(
title = "Figura 2: Densidad Kernel del Margen de Victoria",
x = "Margen de victoria del partido islámico",
y = "Densidad",
caption = "Nota: Si hay salto en x=0 → evidencia de manipulación"
) +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
plot.subtitle = element_text(hjust = 0.5)
)
print(p2)
ggsave("figura2_densidad_Kernel.png", width = 10, height = 6)
# Test formal
density_test <- rddensity(
X = BD_1$ilmvsm1994,
c = 0,
p = 2,              # Polinomio local orden 2
q = 3,              # Bias correction orden 3
kernel = "triangular",
fitselect = "unrestricted"
)
# Mostrar resumen
summary(density_test)
# Extraer resultados clave
test_stat <- density_test$test$t_jk
pvalue <- density_test$test$p_jk
bandwidth_izq <- density_test$h$left
bandwidth_der <- density_test$h$right
# Crear el objeto con histograma para obtener los datos
rdplot_obj <- rdplotdensity(
rdd = density_test,
X = BD_1$ilmvsm1994,
plotRange = c(-0.5, 0.5),
plotN = 25,
plotGrid = c("es","qs"),
type = "points",
CIshade = 0.2,
hist = FALSE,
histBreaks = NULL,
histFillCol = "gray90",
histLineCol = "white",
title = "Figura 3: Test de McCrary",
xlabel = "Islamic win margin (ilmvsm1994)",
ylabel = "Density"
)
dev.copy(png, "figura3_Test_mccrary.png", width = 2400, height = 1800, res = 300)
dev.off()
# Test 1: Islamic mayor 1989
test_i89 <- feols(
i89 ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994,
data = BD_h,
cluster = ~prov
)
# Test 2: Log población 1994
test_lpop <- feols(
lpop1994 ~ islamic_mayor_1994 + ilmvsm1994 + ilmvsm1994:islamic_mayor_1994,
data = BD_h,
cluster = ~prov
)
# Extraer p-values
pval_i89 <- summary(test_i89)$coeftable["islamic_mayor_1994", "Pr(>|t|)"]
pval_lpop <- summary(test_lpop)$coeftable["islamic_mayor_1994", "Pr(>|t|)"]
# Tabla 3 Tests de Balance
etable(
test_i89, test_lpop,
tex = TRUE,
title = "Tests de Balance con P-valores",
headers = c("Islamic 1989", "Log Población 1994"),
dict = c("islamic_mayor_1994" = "Islamic Mayor 1994"),
keep = "Islamic",
extralines = list(
"P-value" = c(sprintf("%.4f", pval_i89), sprintf("%.4f", pval_lpop)),
"Balanceado?" = c(
ifelse(pval_i89 > 0.10, "Sí", "No"),
ifelse(pval_lpop > 0.10, "Sí", "No")
)
),
digits = 4
)
